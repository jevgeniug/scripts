set global FOREIGN_KEY_CHECKS=0;
set FOREIGN_KEY_CHECKS=0;

DROP DATABASE IF EXISTS AAS;

CREATE DATABASE AAS
CHARACTER SET utf8
COLLATE utf8_bin;

USE AAS;

CREATE TABLE ACCOUNTS (
  code bigint(20) NOT NULL AUTO_INCREMENT,
  username varchar(225) NOT NULL,
  company bigint(20) DEFAULT NULL,
  domain varchar(50) DEFAULT NULL,
  dn varchar(255) DEFAULT NULL,
  disabled tinyint(1) DEFAULT 0,
  twoFactorAuthMethod enum ('TOTP') DEFAULT NULL,
  twoFactorSecretKey varchar(32) DEFAULT NULL,
  twoFactorActivated tinyint(1) DEFAULT 0,
  failedLoginCount tinyint(4) DEFAULT 0,
  lastlogindate datetime DEFAULT CURRENT_TIMESTAMP,
  locked tinyint(1) DEFAULT 0,
  securitycode varchar(10) DEFAULT NULL,
  expsecuritycode datetime DEFAULT NULL,
  securitycodetimeout bigint(20) DEFAULT 30,
  multiplesessionaction tinyint(1) DEFAULT NULL COMMENT 'move to personal policy',
  technicalAccount tinyint(4) DEFAULT 0,
  personalPasswordPolicyDn varchar(255) DEFAULT NULL COMMENT 'policy dn',
  personalGroupDn varchar(255) DEFAULT NULL COMMENT 'personal group dn',
  adAccount tinyint(4) DEFAULT 0,
  forename varchar(100) DEFAULT NULL,
  surname varchar(100) DEFAULT NULL,
  `position` varchar(100) DEFAULT NULL,
  PRIMARY KEY (code),
  UNIQUE INDEX dn (dn),
  UNIQUE INDEX username_domain (username, domain),
  CONSTRAINT FK_ACCOUNTS_LOGINDOMAINS FOREIGN KEY (domain)
  REFERENCES LOGINDOMAINS (domain) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT FK_ACCOUNTS_TENANTS FOREIGN KEY (company)
  REFERENCES COMPANIES (code) ON DELETE RESTRICT ON UPDATE RESTRICT
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE ADMINCONFIGURATION (
  name varchar(250) NOT NULL,
  adminCode bigint(20) NOT NULL,
  value mediumtext NOT NULL,
  application bigint(20) NOT NULL,
  service bigint(20) NOT NULL,
  UNIQUE INDEX name_adminCode_application_service (name, adminCode, application, service)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE ADMINS (
  code bigint(20) NOT NULL,
  username varchar(225) NOT NULL
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE COMPANIES (
  code bigint(20) NOT NULL AUTO_INCREMENT,
  id varchar(255) DEFAULT NULL,
  dn varchar(255) NOT NULL COMMENT 'distinguished name',
  name varchar(100) NOT NULL COMMENT 'display name',
  enabled tinyint(4) NOT NULL DEFAULT 1,
  PRIMARY KEY (code),
  UNIQUE INDEX dn (dn),
  UNIQUE INDEX id (id),
  UNIQUE INDEX name (name)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
COMMENT = 'Companies & Organizations'
ROW_FORMAT=COMPRESSED;

CREATE TABLE DBRELEASE (
  VERSION varchar(30) NOT NULL,
  UPDATE_TIME datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (VERSION)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE EVENTLOG (
  code bigint(20) NOT NULL AUTO_INCREMENT,
  type tinyint(4) NOT NULL,
  created datetime NOT NULL,
  message varchar(4000) NOT NULL,
  eventip varchar(50) DEFAULT NULL,
  account bigint(20) DEFAULT NULL COMMENT 'account wchih initaited the event',
  target varchar(255) DEFAULT NULL COMMENT 'record id modified',
  company bigint(20) DEFAULT NULL,
  PRIMARY KEY (code),
  INDEX FK_EVENTLOG_ACCOUNTS_idx (account),
  INDEX FK_EVENTLOG_EVENTTYPE_idx (type),
  CONSTRAINT FK_EVENTLOG_ACCOUNTS FOREIGN KEY (account)
  REFERENCES ACCOUNTS (code) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT FK_EVENTLOG_COMPANIES FOREIGN KEY (company)
  REFERENCES COMPANIES (code) ON DELETE RESTRICT ON UPDATE RESTRICT
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE INFRAACCOUNTS (
  id varchar(50) NOT NULL,
  name varchar(256) NOT NULL,
  dn varchar(256) NOT NULL,
  status enum ('DRAFT', 'ACTIVATED') NOT NULL DEFAULT 'DRAFT',
  PRIMARY KEY (id),
  UNIQUE INDEX `key` (id)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE INSTANCES (
  code bigint(20) NOT NULL AUTO_INCREMENT,
  company bigint(20) NOT NULL DEFAULT 0,
  dn varchar(256) NOT NULL DEFAULT '0',
  name varchar(256) NOT NULL DEFAULT '0',
  PRIMARY KEY (code),
  CONSTRAINT FK_INSTANCES_COMPANIES FOREIGN KEY (company)
  REFERENCES COMPANIES (code) ON DELETE RESTRICT ON UPDATE RESTRICT
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE LOGINDOMAINS (
  domain varchar(255) NOT NULL COMMENT 'domain prefix',
  dn varchar(255) DEFAULT NULL,
  authenticationProvider enum ('AD', 'IMSLDAP') NOT NULL DEFAULT 'IMSLDAP' COMMENT 'authentication provider  ',
  owner bigint(20) NOT NULL,
  enabled tinyint(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (domain),
  UNIQUE INDEX dn (dn),
  CONSTRAINT FK_LOGINDOMAINS_COMPANIES FOREIGN KEY (owner)
  REFERENCES COMPANIES (code) ON DELETE RESTRICT ON UPDATE RESTRICT
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE PARTSADDLOG (
  code bigint(20) NOT NULL AUTO_INCREMENT,
  eventtime datetime NOT NULL,
  eventtype varchar(50) NOT NULL COMMENT 'Possible values are "NOTICE","ERROR","WARNING"',
  eventname varchar(50) NOT NULL COMMENT 'Action being source of the message',
  eventtext text DEFAULT NULL,
  PRIMARY KEY (code)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE SERVICES (
  code bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'CAS id ',
  name varchar(255) DEFAULT NULL COMMENT 'CAS name',
  service varchar(2000) NOT NULL COMMENT 'CAS  serviceId',
  enabled tinyint(1) NOT NULL DEFAULT 0,
  application varchar(255) DEFAULT NULL,
  PRIMARY KEY (code)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE SITES (
  code bigint(20) NOT NULL AUTO_INCREMENT,
  id varchar(255) DEFAULT NULL,
  account varchar(50) NOT NULL COMMENT 'infra account',
  dn varchar(255) DEFAULT NULL,
  name varchar(50) DEFAULT NULL COMMENT 'display name',
  owner bigint(20) NOT NULL COMMENT 'owning company',
  mode enum ('DEDICATED', 'SHARED') DEFAULT 'DEDICATED' COMMENT 'site is  dedicated or shared',
  type enum ('PROD', 'DEV', 'STAGING') DEFAULT NULL COMMENT 'site usage type',
  status enum ('DRAFT', 'SYSTEM_ACCESS', 'SITE_USER_ACCESS', 'CLOSED') NOT NULL DEFAULT 'DRAFT' COMMENT 'site lifecycle status',
  PRIMARY KEY (code),
  UNIQUE INDEX dn (dn),
  INDEX FK_SITES_OWNERS (owner),
  UNIQUE INDEX id_owner (id, owner),
  UNIQUE INDEX name (name)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE SITESERVICES (
  sitecode bigint(20) DEFAULT NULL,
  servicecode bigint(20) DEFAULT NULL,
  INDEX FK_SITESERVICES_SERVICE_idx (servicecode),
  INDEX FK_SITESERVICES_SITE_idx (sitecode),
  UNIQUE INDEX sitecode_servicecode (sitecode, servicecode),
  CONSTRAINT FK_SITESERVICES_SERVICES FOREIGN KEY (servicecode)
  REFERENCES SERVICES (code) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT FK_SITESERVICES_SITES FOREIGN KEY (sitecode)
  REFERENCES SITES (code) ON DELETE RESTRICT ON UPDATE RESTRICT
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED;

CREATE TABLE SSOSESSIONS (
  sessionid varchar(128) DEFAULT NULL COMMENT 'ticket id',
  account int(11) DEFAULT NULL,
  company bigint(20) DEFAULT NULL,
  loginip varchar(50) DEFAULT NULL,
  logindate datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  lastactivitydate datetime DEFAULT NULL,
  hardtimeout int(11) DEFAULT NULL,
  idletimeout int(11) DEFAULT NULL,
  invalid int(1) DEFAULT NULL,
  isopen int(1) DEFAULT NULL COMMENT '<NOOLEAN> 1 - session is open.',
  groupid varchar(128) DEFAULT NULL,
  service int(11) DEFAULT NULL,
  ticket text DEFAULT NULL,
  Code bigint(20) NOT NULL AUTO_INCREMENT,
  Type varchar(5) DEFAULT NULL COMMENT '<ENUM> The type of the stored ticket. TGT - "TicketGrantingTicket" main session record, ST - "ServiceGrantingTicket" service sesssion record, TK - temporary access token for changing password in local AAS.',
  lastActivityDescription varchar(255) DEFAULT NULL,
  accessCount int(11) DEFAULT 0,
  PRIMARY KEY (Code, logindate),
  INDEX FK_SSOSESS_ACC (account),
  INDEX FK_SSOSESS_SERVICES_idx (service),
  INDEX IX_SSOSESS_ISOPEN (isopen),
  INDEX IX_SSOSESS_LAD (lastactivitydate),
  UNIQUE INDEX sessionid_UNIQUE (sessionid, logindate)
)
ENGINE = INNODB
CHARACTER SET utf8
COLLATE utf8_bin
ROW_FORMAT=COMPRESSED
PARTITION BY RANGE COLUMNS (`logindate`)
(
PARTITION SSOS170313 VALUES LESS THAN ('2017-03-14 00:00:00'),
PARTITION SSOS170314 VALUES LESS THAN ('2017-03-15 00:00:00'),
PARTITION SSOS170315 VALUES LESS THAN ('2017-03-16 00:00:00'),
PARTITION SSOS170316 VALUES LESS THAN ('2017-03-17 00:00:00'),
PARTITION SSOS170317 VALUES LESS THAN ('2017-03-18 00:00:00'),
PARTITION SSOS170318 VALUES LESS THAN ('2017-03-19 00:00:00'),
PARTITION SSOS170319 VALUES LESS THAN ('2017-03-20 00:00:00'),
PARTITION SSOS170320 VALUES LESS THAN ('2017-03-21 00:00:00'),
PARTITION SSOS170321 VALUES LESS THAN ('2017-03-22 00:00:00'),
PARTITION SSOS170322 VALUES LESS THAN ('2017-03-23 00:00:00'),
PARTITION SSOS170323 VALUES LESS THAN ('2017-03-24 00:00:00'),
PARTITION SSOS170324 VALUES LESS THAN ('2017-03-25 00:00:00'),
PARTITION SSOS170325 VALUES LESS THAN ('2017-03-26 00:00:00'),
PARTITION SSOS170326 VALUES LESS THAN ('2017-03-27 00:00:00'),
PARTITION SSOS170327 VALUES LESS THAN ('2017-03-28 00:00:00'),
PARTITION SSOS170328 VALUES LESS THAN ('2017-03-29 00:00:00'),
PARTITION SSOS170329 VALUES LESS THAN ('2017-03-30 00:00:00'),
PARTITION SSOS170330 VALUES LESS THAN ('2017-03-31 00:00:00'),
PARTITION SSOS170331 VALUES LESS THAN ('2017-04-01 00:00:00'),
PARTITION SSOS170401 VALUES LESS THAN ('2017-04-02 00:00:00'),
PARTITION SSOS170402 VALUES LESS THAN ('2017-04-03 00:00:00'),
PARTITION SSOS170403 VALUES LESS THAN ('2017-04-04 00:00:00'),
PARTITION SSOS170404 VALUES LESS THAN ('2017-04-05 00:00:00'),
PARTITION SSOS170405 VALUES LESS THAN ('2017-04-06 00:00:00'),
PARTITION SSOS170406 VALUES LESS THAN ('2017-04-07 00:00:00'),
PARTITION SSOS170407 VALUES LESS THAN ('2017-04-08 00:00:00'),
PARTITION SSOS170408 VALUES LESS THAN ('2017-04-09 00:00:00'),
PARTITION SSOS170409 VALUES LESS THAN ('2017-04-10 00:00:00'),
PARTITION SSOS170410 VALUES LESS THAN ('2017-04-11 00:00:00'),
PARTITION SSOS170411 VALUES LESS THAN ('2017-04-12 00:00:00'),
PARTITION SSOS170412 VALUES LESS THAN ('2017-04-13 00:00:00'),
PARTITION SSOS170413 VALUES LESS THAN ('2017-04-14 00:00:00'),
PARTITION SSOS170414 VALUES LESS THAN ('2017-04-15 00:00:00'),
PARTITION SSOS170415 VALUES LESS THAN ('2017-04-16 00:00:00'),
PARTITION SSOS170416 VALUES LESS THAN ('2017-04-17 00:00:00'),
PARTITION SSOS170417 VALUES LESS THAN ('2017-04-18 00:00:00'),
PARTITION SSOS170418 VALUES LESS THAN ('2017-04-19 00:00:00'),
PARTITION SSOS170419 VALUES LESS THAN ('2017-04-20 00:00:00'),
PARTITION SSOS170420 VALUES LESS THAN ('2017-04-21 00:00:00'),
PARTITION SSOS170421 VALUES LESS THAN ('2017-04-22 00:00:00'),
PARTITION SSOS170422 VALUES LESS THAN ('2017-04-23 00:00:00'),
PARTITION SSOS170423 VALUES LESS THAN ('2017-04-24 00:00:00'),
PARTITION SSOS170424 VALUES LESS THAN ('2017-04-25 00:00:00'),
PARTITION SSOS170425 VALUES LESS THAN ('2017-04-26 00:00:00'),
PARTITION SSOS170426 VALUES LESS THAN ('2017-04-27 00:00:00'),
PARTITION SSOS170427 VALUES LESS THAN ('2017-04-28 00:00:00'),
PARTITION SSOS170428 VALUES LESS THAN ('2017-04-29 00:00:00'),
PARTITION SSOS170429 VALUES LESS THAN ('2017-04-30 00:00:00'),
PARTITION SSOS170430 VALUES LESS THAN ('2017-05-01 00:00:00'),
PARTITION SSOS170501 VALUES LESS THAN ('2017-05-02 00:00:00'),
PARTITION SSOS170502 VALUES LESS THAN ('2017-05-03 00:00:00'),
PARTITION SSOS170503 VALUES LESS THAN ('2017-05-04 00:00:00'),
PARTITION SSOS170504 VALUES LESS THAN ('2017-05-05 00:00:00'),
PARTITION SSOS170505 VALUES LESS THAN ('2017-05-06 00:00:00'),
PARTITION SSOS170506 VALUES LESS THAN ('2017-05-07 00:00:00'),
PARTITION SSOS170507 VALUES LESS THAN ('2017-05-08 00:00:00'),
PARTITION SSOS170508 VALUES LESS THAN ('2017-05-09 00:00:00'),
PARTITION SSOS170509 VALUES LESS THAN ('2017-05-10 00:00:00'),
PARTITION SSOS170510 VALUES LESS THAN ('2017-05-11 00:00:00'),
PARTITION SSOS170511 VALUES LESS THAN ('2017-05-12 00:00:00')
);

set global FOREIGN_KEY_CHECKS=1;
set FOREIGN_KEY_CHECKS=1;
